#!/bin/sh

. network.config
/usr/bin/redes_up.sh
. sgroutes

echo 1 > /proc/sys/net/ipv4/ip_dynaddr
echo 1 > /proc/sys/net/ipv4/ip_forward
echo 1 > /proc/sys/net/ipv4/tcp_syncookies

#modprobe ip_tables
modprobe ip_gre
modprobe ip_conntrack_ftp
modprobe ip_conntrack
modprobe ip_nat_ftp
modprobe ip_conntrack_sip
modprobe ip_nat_sip
modprobe ip_conntrack_h323
modprobe ip_nat_h323

SQUIDPORT=3128
SSLPORT=3128
export IPTABLES=`which iptables`

echo "Limpando as cadeias..."
$IPTABLES -F
$IPTABLES -Z
$IPTABLES -X
$IPTABLES -t nat -F
$IPTABLES -t nat -Z
$IPTABLES -t nat -X
$IPTABLES -t mangle -F
$IPTABLES -t mangle -Z
$IPTABLES -t mangle -X
$IPTABLES -t mangle -A PREROUTING -j CONNMARK --restore-mark

echo "Definindo politicas padrao.."
$IPTABLES -P FORWARD ACCEPT

echo "Mascarando conexoes saida..."
#$IPTABLES -t nat -A POSTROUTING -o $WAN_IF1 -s 192.168.81.250 -j SNAT --to 200.215.53.186
#$IPTABLES -t nat -A POSTROUTING -o $WAN_IF1 -s 192.168.0.2 -j SNAT --to 177.10.216.178
#$IPTABLES -t nat -A POSTROUTING -o $WAN_IF2 -s 192.168.81.1 -j SNAT --to 187.52.189.3
#$IPTABLES -t nat -A POSTROUTING -o $WAN_IF1 -s $LAN_NET1 -j SNAT --to 187.52.189.2-187.52.189.5
#$IPTABLES -t nat -A POSTROUTING -o $WAN_IF2 -s $LAN_NET1 -j SNAT --to 172.16.0.2

. masq.sh

echo "Aceitar IP dos modems"
$IPTABLES -A INPUT -s $WAN_GW1 -i $WAN_IF1 -j ACCEPT
#$IPTABLES -A INPUT -s $WAN_GW2 -i $WAN_IF2 -j ACCEPT

echo "Bloqueando ataques conhecidos..."
# Bloqueia PING da morte
$IPTABLES -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/s -j ACCEPT

# Anti-Spoofings
$IPTABLES -A INPUT -s 10.0.0.0/8 -i $WAN_IF1 -j DROP
#$IPTABLES -A INPUT -s 10.0.0.0/8 -i $WAN_IF2 -j DROP
$IPTABLES -A INPUT -s 127.0.0.0/8 -i $WAN_IF1 -j DROP
#$IPTABLES -A INPUT -s 127.0.0.0/8 -i $WAN_IF2 -j DROP
$IPTABLES -A INPUT -s 172.16.0.0/12 -i $WAN_IF1 -j DROP
#$IPTABLES -A INPUT -s 172.16.0.0/12 -i $WAN_IF2 -j DROP
$IPTABLES -A INPUT -s 192.168.0.0/16 -i $WAN_IF1 -j DROP
#$IPTABLES -A INPUT -s 192.168.0.0/16 -i $WAN_IF2 -j DROP

# Contra pacotes indesejaveis
$IPTABLES -A INPUT -p tcp ! --syn -m state --state NEW -j DROP

# Contra alguns worms
$IPTABLES -A INPUT -p tcp --dport 135 -i $LAN_IF1  -j REJECT

echo "Bloqueando UltraSurf!"
. registra.sh
$IPTABLES -A FORWARD -p tcp --dport 33190 -j DROP

echo "Eliminando pacotes fragmentados..."
#$IPTABLES -A INPUT -f -j LOG --log-prefix "FRAGMENT: "
#$IPTABLES -A INPUT -f -j DROP
#$IPTABLES -A FORWARD -f -j LOG --log-prefix "FRAGMENT: "
#$IPTABLES -A FORWARD -f -j DROP

echo "Eliminando pacotes invalidos..."
#$IPTABLES -A INPUT -m state --state INVALID -j LOG --log-prefix "IN INVALID: "
#$IPTABLES -A INPUT -m state --state INVALID -j DROP
#$IPTABLES -A FORWARD -m state --state INVALID -j LOG --log-prefix "FW INVALID: "
#$IPTABLES -A FORWARD -m state --state INVALID -j DROP

echo "Mantendo conexoes existentes ..."
$IPTABLES -t filter -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
$IPTABLES -t filter -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT

echo "Liberando conexao local..."
$IPTABLES -t filter -A INPUT -p icmp -j ACCEPT
$IPTABLES -t filter -A INPUT -i lo -j ACCEPT
#$IPTABLES -t filter -A FORWARD -p icmp -j ACCEPT
$IPTABLES -t filter -A FORWARD -i lo -j ACCEPT
#$IPTABLES -t filter -A FORWARD -o $IFTEXT -j ACCEPT

echo "Balanceando saidas..."
#$IPTABLES -t mangle -A PREROUTING -m state --state new -m statistic --mode random --probability 0.5 -j MARK --set-mark 2
#$IPTABLES -t mangle -A PREROUTING -m state --state new -j MARK --set-mark 1
#$IPTABLES -t mangle -A OUTPUT -m state --state new -m statistic --mode random --probability 0.5 -j MARK --set-mark 2
#$IPTABLES -t mangle -A OUTPUT -m state --state new -j MARK --set-mark 1

echo "Fixando links pelas portas..."
$IPTABLES -t mangle -A OUTPUT -p icmp -o $WAN_IF1 -j MARK --set-mark 1
#$IPTABLES -t mangle -A OUTPUT -p icmp -o $WAN_IF2 -j MARK --set-mark 2
$IPTABLES -t mangle -A PREROUTING -i eth1 -j CONNMARK --set-mark 111
$IPTABLES -t mangle -A PREROUTING -m connmark --mark 111 -j MARK --set-mark 1
#$IPTABLES -t mangle -A PREROUTING -i eth2 -j CONNMARK --set-mark 222
#$IPTABLES -t mangle -A PREROUTING -m connmark --mark 222 -j MARK --set-mark 2

#$IPTABLES -t mangle -A OUTPUT -p tcp --dport 53 -j MARK --set-mark 2
#$IPTABLES -t mangle -A OUTPUT -p udp --dport 53 -j MARK --set-mark 2
#$IPTABLES -t mangle -A OUTPUT -p tcp --dport 80 -j MARK --set-mark 2
#$IPTABLES -t mangle -A OUTPUT -p tcp --dport 443 -j MARK --set-mark 2
#$IPTABLES -t mangle -A OUTPUT -p tcp --dport 8080 -j MARK --set-mark 2

#$IPTABLES -t mangle -A OUTPUT -p udp --dport 5102 -j MARK --set-mark 1
#$IPTABLES -t mangle -A OUTPUT -p udp --dport 5103 -j MARK --set-mark 1
#$IPTABLES -t mangle -A OUTPUT -d 189.73.93.79 -j MARK --set-mark 1
#$IPTABLES -t mangle -A OUTPUT -p udp -j MARK --set-mark 1

#$IPTABLES -t mangle -A PREROUTING -s $LAN_NET1 -p tcp --dport 53 -j MARK --set-mark 2
#$IPTABLES -t mangle -A PREROUTING -s $LAN_NET1 -p udp --dport 53 -j MARK --set-mark 2
#$IPTABLES -t mangle -A PREROUTING -s $LAN_NET1 -p tcp --dport 80 -j MARK --set-mark 2
#$IPTABLES -t mangle -A PREROUTING -s $LAN_NET1 -p tcp --dport 443 -j MARK --set-mark 2
#$IPTABLES -t mangle -A PREROUTING -s $LAN_NET1 -p tcp --dport 8080 -j MARK --set-mark 2 

#$IPTABLES -t mangle -A PREROUTING -s 192.168.0.201 -j MARK --set-mark 1

echo "Definindo prioridades..."
$IPTABLES -t mangle -A OUTPUT -p udp --dport 53 -j TOS --set-tos 0x10

echo "Capturando conversas do Jabber..."
$IPTABLES -t nat -A PREROUTING -p tcp --destination-port 5222 -j REDIRECT --to-ports 16667

echo "Desviando DNS..."
#$IPTABLES -t filter -A FORWARD -i $LAN_IF1 -m state --state NEW -m tcp -p tcp -s 192.168.81.250 -d 0.0.0.0/0 --dport 53 -j ACCEPT
#$IPTABLES -t nat -A PREROUTING -s 192.168.81.250 -p tcp -d 0.0.0.0/0 --dport 53 -j ACCEPT
#$IPTABLES -t filter -A FORWARD -i $LAN_IF1 -m state --state NEW -m udp -p udp -s 192.168.81.250 -d 0.0.0.0/0 --dport 53 -j ACCEPT
#$IPTABLES -t nat -A PREROUTING -s 192.168.81.250 -p udp -d 0.0.0.0/0 --dport 53 -j ACCEPT
$IPTABLES -t nat -A PREROUTING -s $LAN_NET1 -p tcp --dport 53 -j REDIRECT --to-port 53
$IPTABLES -t nat -A PREROUTING -s $LAN_NET1 -p udp --dport 53 -j REDIRECT --to-port 53

# Direcionando trafego de SMTP vindo da rede interna para o servidor de e-mails
#$IPTABLES -t nat -A PREROUTING -i $LAN_IF1 -d 200.215.53.186 -p tcp --dport 25 -j DNAT --to-destination 192.168.81.250
#$IPTABLES -t nat -A PREROUTING -i $LAN_IF1 -d 200.215.53.186 -p tcp --dport 587 -j DNAT --to-destination 192.168.81.250
#$IPTABLES -t filter -A FORWARD -i $LAN_IF1 -m tcp -p tcp -d 192.168.81.250 --dport 25 -j ACCEPT
#$IPTABLES -t filter -A FORWARD -i $LAN_IF1 -m tcp -p tcp -d 192.168.81.250 --dport 587 -j ACCEPT

echo "Levantando regras dinamicas..."
#echo " - Acesso Publico"
#. weblogin.sh
echo " - IPs bloqueados"
. block.sh
echo " - Liberacao de VPNs"
. vpn.sh
echo " - Acesso entre redes"
. acesso.sh
. lan2lan.sh
echo " - Portas persistentes"
. persistports.sh
echo " - NAT"
. nat.sh
echo " - Enderecos MSN"
. msn.sh
echo " - Acessos ao MSN"
. libera_msn.sh
echo " - Bypass"
. bypass.sh
echo " - Bloqueios ao SMTP"
$IPTABLES -A FORWARD -p tcp --dport 25 -j LOG --log-level 1 --log-prefix 'SMTP: '
$IPTABLES -A FORWARD -p tcp --dport 26 -j LOG --log-level 1 --log-prefix 'SMTP: '
$IPTABLES -A FORWARD -p tcp --dport 465 -j LOG --log-level 1 --log-prefix 'SMTP: '
$IPTABLES -A FORWARD -p tcp --dport 587 -j LOG --log-level 1 --log-prefix 'SMTP: '
$IPTABLES -A FORWARD -p tcp -m multiport --dport 25,26,465,587 -j DROP
echo " - Portas proxy desviadas"
. proxy.sh
echo " - Liberacao ranges dinamicos"
. range.sh
echo " - Liberacao hosts da rede"
. libera.sh
echo " - Portas abertas"
. openports.sh

$IPTABLES -t mangle -A PREROUTING -j CONNMARK --save-mark

echo " - Criando cadeias do Fail2Ban"
$IPTABLES -N f2b-ultrasurf
$IPTABLES -A f2b-ultrasurf -j RETURN
$IPTABLES -I FORWARD -j f2b-ultrasurf

$IPTABLES -N f2b-ultrasurf_input
$IPTABLES -A f2b-ultrasurf_input -j RETURN
$IPTABLES -I INPUT -j f2b-ultrasurf_input

$IPTABLES -N f2b-utorrent
$IPTABLES -A f2b-utorrent -j RETURN
$IPTABLES -I FORWARD -j f2b-utorrent

$IPTABLES -N f2b-utorrent_input
$IPTABLES -A f2b-utorrent_input -j RETURN
$IPTABLES -I INPUT -j f2b-utorrent_input

$IPTABLES -N f2b-ares_galaxy
$IPTABLES -A f2b-ares_galaxy -j RETURN
$IPTABLES -I FORWARD -j f2b-ares_galaxy

$IPTABLES -N f2b-ares_galaxy_input
$IPTABLES -A f2b-ares_galaxy_input -j RETURN
$IPTABLES -I INPUT -j f2b-ares_galaxy_input

$IPTABLES -N f2b-tor_project
$IPTABLES -A f2b-tor_project -j RETURN
$IPTABLES -I FORWARD -j f2b-tor_project

$IPTABLES -N f2b-tor_project_input
$IPTABLES -A f2b-tor_project_input -j RETURN
$IPTABLES -I INPUT -j f2b-tor_project_input

echo "Bloqueando todo o resto!!!"
$IPTABLES -t filter -A INPUT -j REJECT --reject-with icmp-host-prohibited
$IPTABLES -t filter -A FORWARD -j REJECT --reject-with icmp-host-prohibited

